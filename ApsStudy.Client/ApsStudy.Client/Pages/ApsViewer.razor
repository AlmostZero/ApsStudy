@page "/aps-viewer"
@using ApsStudy.Shared.DTOs
@using System.Text.Json
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<PageTitle>APS Viewer</PageTitle>

<div class="container-fluid h-100 p-0 d-flex flex-column">

    <div class="d-flex align-items-center gap-2 p-2 bg-white border-bottom" style="height: 50px; flex-shrink: 0;">
        <button class="btn btn-outline-secondary btn-sm" @onclick="LoadFiles">
            リスト更新
        </button>

        <select class="form-select form-select-sm" style="max-width: 400px;" @bind="selectedUrn">
            <option value="">-- モデルを選択してください --</option>
            @if ( files != null )
            {
                @foreach ( var file in files )
                {
                    <option value="@file.Urn">@file.FileName</option>
                }
            }
        </select>

        <button class="btn btn-primary btn-sm px-4" @onclick="LoadSelectedModel" disabled="@string.IsNullOrEmpty( selectedUrn )">
            モデル表示
        </button>

        <button class="btn btn-outline-danger btn-sm ms-auto" @onclick="DeleteSelectedFile" disabled="@string.IsNullOrEmpty( selectedUrn )">
            ファイル削除
        </button>
    </div>

    <div class="flex-grow-1 position-relative" style="overflow: hidden;">

        <div class="d-flex h-100 w-100" id="viewerContainer">

            <div id="viewer2d" style="width:calc(50% - 5px); height:100%; position:relative; background-color:white;">
                <div class="position-absolute text-white px-2 py-1" style="top:0; left:0; z-index:10; font-size:12px; background:rgba(0,0,0,0.5);">
                    2D シート (図面)
                </div>
            </div>

            <div id="viewerGutter" class="gutter-col">
                <div class="gutter-handle"></div>
            </div>

            <div id="viewer3d" style="width:calc(50% - 5px); height:100%; position:relative; background-color:white;">
                <div class="position-absolute text-white px-2 py-1" style="top:0; left:0; z-index:10; font-size:12px; background:rgba(0,0,0,0.5);">
                    3D ビュー (モデル)
                </div>
            </div>

        </div>

        @if ( !string.IsNullOrEmpty( statusMessage ) )
        {
            <div class="d-flex align-items-center justify-content-center h-100 text-white"
                 style="position:absolute; top:0; left:0; width:100%; z-index:99; pointer-events:none; background-color: rgba(0,0,0,0.6);">
                <div style="pointer-events:auto;">
                    <h5>@statusMessage</h5>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private List<BucketObjectDto>? files;
    private string selectedUrn = "";
    private string statusMessage = "";
    private const string ServerUrl = "https://localhost:7107";

    protected override async Task OnInitializedAsync()
    {
        await LoadFiles();
    }

    // 렌더링이 끝난 후 JS 연결 (리사이즈 바 활성화)
    protected override async Task OnAfterRenderAsync( bool firstRender )
    {
        if ( firstRender )
        {
            // 화면이 처음 그려지면 리사이즈 기능을 켭니다.
            await JSRuntime.InvokeVoidAsync( "enableResizer", "viewer2d", "viewer3d", "viewerGutter" );
        }
    }

    private async Task LoadFiles()
    {
        try
        {
            files = await Http.GetFromJsonAsync<List<BucketObjectDto>>( $"{ServerUrl}/api/aps/bucket" );
            StateHasChanged();
        }
        catch ( Exception ex )
        {
            await JSRuntime.InvokeVoidAsync( "alert", $"リストの読み込みに失敗しました: {ex.Message}" );
        }
    }

    private async Task LoadSelectedModel()
    {
        if ( string.IsNullOrEmpty( selectedUrn ) ) return;

        try
        {
            statusMessage = "トークン取得中...";
            StateHasChanged();

            var tokenRes = await Http.GetFromJsonAsync<JsonElement>( $"{ServerUrl}/api/aps/token" );
            var token = tokenRes.GetProperty( "accessToken" ).ToString();

            statusMessage = "ビューアー起動中...";
            StateHasChanged();

            await JSRuntime.InvokeVoidAsync( "launchDualViewer", "viewer2d", "viewer3d", selectedUrn, token );

            statusMessage = "";
        }
        catch ( Exception ex )
        {
            statusMessage = "";
            await JSRuntime.InvokeVoidAsync( "alert", $"ビューアーの起動に失敗しました: {ex.Message}" );
        }
    }

    private async Task DeleteSelectedFile()
    {
        if ( string.IsNullOrEmpty( selectedUrn ) ) return;

        var targetFile = files?.FirstOrDefault( f => f.Urn == selectedUrn );
        if ( targetFile == null ) return;

        bool confirmed = await JSRuntime.InvokeAsync<bool>( "confirm", $"'{targetFile.FileName}' を本当に削除しますか？" );
        if ( !confirmed ) return;

        try
        {
            var response = await Http.DeleteAsync( $"{ServerUrl}/api/aps/bucket/{targetFile.FileName}" );
            if ( response.IsSuccessStatusCode )
            {
                await JSRuntime.InvokeVoidAsync( "alert", "削除しました。" );
                selectedUrn = "";
                await LoadFiles();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync( "alert", "削除に失敗しました。" );
            }
        }
        catch ( Exception ex )
        {
            await JSRuntime.InvokeVoidAsync( "alert", $"エラー: {ex.Message}" );
        }
    }
}