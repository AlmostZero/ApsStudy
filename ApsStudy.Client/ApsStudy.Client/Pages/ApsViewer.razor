@page "/aps-viewer"
@using ApsStudy.Shared.DTOs
@using System.Text.Json
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<PageTitle>APS Viewer</PageTitle>

<div class="container-fluid h-100 p-0">
    <div class="row h-100 g-0">
        <div class="col-md-3 border-end bg-light p-3 d-flex flex-column">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="m-0">📂 파일함</h4>
                <button class="btn btn-primary btn-sm" @onclick="LoadFiles" title="목록 새로고침">
                    🔄
                </button>
            </div>

            @if ( files == null )
            {
                <p class="text-center mt-3">📡 서버 통신 중...</p>
            }
            else if ( files.Count == 0 )
            {
                <p class="text-center mt-3 text-muted">파일이 없습니다.<br>Postman으로 업로드 해보세요.</p>
            }
            else
            {
                <div class="list-group overflow-auto" style="flex:1;">
                    @foreach ( var file in files )
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0 fw-bold text-truncate" title="@file.FileName" style="max-width: 65%;">
                                    📄 @file.FileName
                                </h6>
                                <div>
                                    <button class="btn btn-outline-dark btn-sm me-1" @onclick="() => DebugManifest( file.Urn )" title="F12 콘솔에 상세 로그 찍기">
                                        🐞
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteFile( file.FileName )" title="파일 삭제">
                                        🗑️
                                    </button>
                                </div>
                            </div>

                            <div class="btn-group w-100">
                                @if ( file.TranslationStatus == "success" )
                                {
                                    <button class="btn btn-success btn-sm" @onclick="() => ViewModel( file.Urn )">
                                        👁️ 바로 보기
                                    </button>
                                }
                                else if ( file.TranslationStatus == "inprogress" )
                                {
                                    <button class="btn btn-secondary btn-sm" disabled>
                                        ⏳ 변환 중...
                                    </button>
                                }
                                else if ( file.TranslationStatus == "failed" )
                                {
                                    <button class="btn btn-danger btn-sm disabled">
                                        ❌ 변환 실패
                                    </button>
                                }
                                else if ( file.TranslationStatus == "checking" )
                                {
                                    <button class="btn btn-light btn-sm disabled">
                                        🔍 확인 중...
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-warning btn-sm" @onclick="() => RequestTranslate( file.ObjectId )">
                                        🍳 변환하기
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>

        <div class="col-md-9 p-0 position-relative">

            <div id="forgeViewer"
                 style="width:100%; height:100%; position:absolute; top:0; left:0; overflow:hidden; background-color:#333;">

                @if ( !string.IsNullOrEmpty( statusMessage ) )
                {
                    <div class="d-flex align-items-center justify-content-center h-100 text-white"
                         style="position:absolute; top:0; left:0; width:100%; z-index:99; pointer-events:none;">
                        <div style="pointer-events:auto;">
                            @if ( statusMessage == "준비 완료" )
                            {
                                <h3>👈 왼쪽에서 파일을 선택해주세요</h3>
                            }
                            else
                            {
                                <h5>@statusMessage</h5>
                            }
                        </div>
                    </div>
                }

            </div>
        </div>
    </div>
</div>

@code {
    // Shared 프로젝트에 있는 DTO 사용
    private List<BucketObjectDto>? files;
    private string statusMessage = "준비 완료";

    // [주의] 형님 포트 번호 확인 (launchSettings.json)
    private const string ServerUrl = "https://localhost:7107";

    protected override async Task OnInitializedAsync()
    {
        await LoadFiles();
    }

    // 1. 파일 목록 불러오기 + 상태 체크
    private async Task LoadFiles()
    {
        try
        {
            files = await Http.GetFromJsonAsync<List<BucketObjectDto>>( $"{ServerUrl}/api/aps/bucket" );
            StateHasChanged(); // 목록 먼저 표시

            // 각 파일 상태 전수조사 (URN 기반)
            foreach ( var file in files )
            {
                try
                {
                    // [중요] objectId 대신 urn 사용! (인코딩 문제 해결)
                    var res = await Http.GetFromJsonAsync<JsonElement>( $"{ServerUrl}/api/derivative/status?urn={file.Urn}" );
                    file.TranslationStatus = res.GetProperty( "status" ).ToString();
                    StateHasChanged();
                }
                catch
                {
                    file.TranslationStatus = "n/a";
                }
            }
        }
        catch ( Exception ex )
        {
            statusMessage = $"목록 로드 실패: {ex.Message}";
        }
    }

    // 2. 파일 삭제
    private async Task DeleteFile( string fileName )
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>( "confirm", $"'{fileName}' 파일을 영구 삭제하시겠습니까?" );
        if ( !confirmed ) return;

        try
        {
            var response = await Http.DeleteAsync( $"{ServerUrl}/api/aps/bucket/{fileName}" );
            if ( response.IsSuccessStatusCode )
            {
                await LoadFiles(); // 목록 새로고침
                await JSRuntime.InvokeVoidAsync( "alert", "삭제되었습니다." );
            }
            else
            {
                await JSRuntime.InvokeVoidAsync( "alert", "삭제 실패!" );
            }
        }
        catch ( Exception ex )
        {
            await JSRuntime.InvokeVoidAsync( "alert", $"에러: {ex.Message}" );
        }
    }

    // 3. 변환 요청 (수동)
    private async Task RequestTranslate( string objectId )
    {
        var target = files.FirstOrDefault( f => f.ObjectId == objectId );
        if ( target != null ) { target.TranslationStatus = "inprogress"; StateHasChanged(); }

        try
        {
            var response = await Http.PostAsJsonAsync( $"{ServerUrl}/api/derivative/translate", objectId );
            if ( response.IsSuccessStatusCode )
            {
                await JSRuntime.InvokeVoidAsync( "alert", "변환 요청 성공! 잠시 후 [새로고침] 하세요." );
            }
            else
            {
                var msg = await response.Content.ReadAsStringAsync();
                await JSRuntime.InvokeVoidAsync( "alert", $"요청 실패: {msg}" );
                if ( target != null ) target.TranslationStatus = "failed";
            }
        }
        catch ( Exception ex )
        {
            await JSRuntime.InvokeVoidAsync( "alert", $"에러: {ex.Message}" );
        }
    }

    // 4. 뷰어 실행 (JS 호출)
    private async Task ViewModel( string urn )
    {
        try
        {
            statusMessage = "토큰 발급 중...";
            StateHasChanged();

            var tokenRes = await Http.GetFromJsonAsync<JsonElement>( $"{ServerUrl}/api/aps/token" );
            var token = tokenRes.GetProperty( "accessToken" ).ToString();

            statusMessage = "뷰어 로딩 중...";
            StateHasChanged();

            // wwwroot/js/viewerHelper.js 의 launchViewer 호출
            await JSRuntime.InvokeVoidAsync( "launchViewer", "forgeViewer", urn, token );

            statusMessage = ""; // 메시지 지움 (화면 가리니까)
        }
        catch ( Exception ex )
        {
            statusMessage = $"뷰어 실행 실패: {ex.Message}";
        }
    }

    // 5. [신규] 상세 Manifest 디버그 (F12 콘솔 출력)
    private async Task DebugManifest( string urn )
    {
        try
        {
            await JSRuntime.InvokeVoidAsync( "console.log", $"🔍 부검 시작 (URN: {urn})" );

            // 상세 정보 API 호출 (URN 사용)
            var manifest = await Http.GetFromJsonAsync<JsonElement>( $"{ServerUrl}/api/derivative/manifest?urn={urn}" );

            // 콘솔에 객체 덤프
            await JSRuntime.InvokeVoidAsync( "console.log", manifest );
            await JSRuntime.InvokeVoidAsync( "alert", "브라우저 개발자 도구(F12) -> Console 탭을 확인하세요!" );
        }
        catch ( Exception ex )
        {
            await JSRuntime.InvokeVoidAsync( "console.error", ex.Message );
            await JSRuntime.InvokeVoidAsync( "alert", "Manifest 조회 실패 (아직 변환 요청 안 했을 수도 있음)" );
        }
    }
}